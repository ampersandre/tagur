<!DOCTYPE html>
<html>
<head>
    <title>Tagur</title>
    <link href='http://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/css/style.css"/>
    <link rel="stylesheet" href="/css/tagur.css"/>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="/js/tagur.js"></script>
    <script>
        $(function() {
            var loadImageButton = $('#loadImageButton');
            var imageContainer = $('#imageContainer');

            var imageUrlInput = $('#urlInput').keypress(function (e) {
                if (e.which == 13) {
                    loadImageButton.click();
                    return false;
                }
            });
            loadImageButton.click(function() {
                var imageUrl = imageUrlInput.val();
                var encodedUrl = encodeURIComponent(imageUrl);
                $.post('/new/', { src: imageUrl },
                    function(imageData) {

                        loadTagur(imageData, imageUrl);
                    });
            });
            function loadTagur(imageJson, imageUrl) {
                $('#caption').hide();
                imageUrl = imageUrl || imageJson[0].src;
                var image = new Image();
                imageContainer.html('<img src="' + imageUrl + '" id="targetImage"/>');

                $(image).on('load', function() {
                    var permalink = $('<a href="" class="permalink">Link to this image</a>').hide();
                    imageContainer.append(permalink);
                    var commentImage = Tagur.prepare({
                        id: 'targetImage',
                        onCommentAdded: function (comment) {
                            $.post('/image/', {
                                src: commentImage.src,
                                comment: comment.comment,
                                xP: comment.xP,
                                yP: comment.yP
                            }, function (data) {
                                permalink.show().attr('href', '/image/' + data._id);
                            });
                        }
                    });

                    if (imageJson.length > 0) {
                        permalink.show().attr('href', '/image/' + imageJson[0]._id);
                        var comments = imageJson[0].comments;
                        for (var i = 0; i < comments.length; i++) {
                            var comment = comments[i];
                            commentImage.addComment({
                                xP: comment.xP,
                                yP: comment.yP,
                                comment: comment.text
                            });
                        }
                    }
                });
                image.src = imageUrl;
            }

            loadTagur(
            {{#imageJson}} [{
                _id: "{{id}}", src: "{{src}}", comments:[ {{#comments}} {
                    xP: {{xP}},
                    yP: {{yP}},
                    text: "{{text}}"
                } {{^last}} , {{/last}} {{/comments}} ]
            }] {{/imageJson}});
            $('#caption').show();
        });
    </script>
</head>
<body style="text-align: center">
<div id="body">
    <header><h1>Tagur.</h1></header>
    <div class="clearfix">
        <div id="left">
            {{#caption}}<h2 id="caption" style="display: none;">{{caption}}</h2>{{/caption}}
            <div id="imageContainer">
            </div>
        </div>
        <div id="right">
            <h2>Make one of your own</h2>
            <input id="urlInput" name="src" placeholder="Paste image URL"/>
            <button id="loadImageButton">Load Image</button>
            <h2>Or, upload an image</h2>
            <form id="uploadForm" method="post" action="/image/upload" enctype="multipart/form-data">
                <input type="file" name="uploadedImage"/>
                <br/>
                <input type="submit">Upload</input>
            </form>
        </div>
    </div>
    <footer>Built by <a href="https://github.com/ampersandre/tagur">ampersandre</a> in Node.js with Express, Mongoose and Hogan <img src="/images/hogan-icon.png"/></footer>
</div>
</body>
</html>